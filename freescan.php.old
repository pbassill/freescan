<?php

/*
 * Plugin Name: Secure GI Free Scan
 * Plugin URI:  https://www.hedgehogsecurity.gi/secure-gi
 * Description: Secure GI - free website vulnerability scanner
 * Version:     1.0.01
 * Author:      Peter Bassill
 * Author URI:  https://peterbassill.com
 * License:     Commercial
 * License URI: https://peterbassill.com/secure-gi
 *
 * */

include('functions.php');

function freescan() {

	$pentesttools_apikey="9525c4535b9c1b22b39fecef501551e4e5cf89ac";

	if(ISSET($_POST['submit'])) {
		$target = $_POST['url'];
		ob_start();
		echo "Queuing the job...";
		flush();
		ob_flush();
		$payload = "{\"op\":\"start_scan\",\"tool_id\":170,\"tool_params\":{\"target\":\"$target\",\"scan_type\":\"quick\",\"follow_redirects\":\"true\"}}";
		$api_url = "https://pentest-tools.com/api?key=$pentesttools_apikey";
        	$ch = curl_init( $api_url );
        	curl_setopt( $ch, CURLOPT_POSTFIELDS, $payload );
        	curl_setopt( $ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
        	curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
        	$json_data = curl_exec($ch);
        	curl_close($ch);

		$json = json_decode($json_data);
		$scan_id = $json->scan_id;
		$scan_status = $json->scan_status;
                echo $scan_status;
		flush();
		ob_flush();
		if($scan_status = "waiting") {
			while($scan_status == "waiting"){
				sleep(5);
				$payload = "{\"op\":\"get_scan_status\",\"scan_id\":$scan_id}";
				$api_url = "https://pentest-tools.com/api?key=$pentesttools_apikey";
                		$ch = curl_init( $api_url );
               		 	curl_setopt( $ch, CURLOPT_POSTFIELDS, $payload );
                		curl_setopt( $ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
                		curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
				$json_data = curl_exec($ch);
				curl_close($ch);

				$json = json_decode($json_data);
				$scan_status = $json->scan_status;
				echo $scan_status;
				flush();
				ob_flush();
			}
		}

		if($scan_status = "running") {
                        while($scan_status == "running"){
                                sleep(5);
                                $payload = "{\"op\":\"get_scan_status\",\"scan_id\":$scan_id}";
                                $api_url = "https://pentest-tools.com/api?key=$pentesttools_apikey";
                                $ch = curl_init( $api_url );
                                curl_setopt( $ch, CURLOPT_POSTFIELDS, $payload );
                                curl_setopt( $ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
                                curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
                                $json_data = curl_exec($ch);
				curl_close($ch);

				$json = json_decode($json_data);
				$scan_status = $json->scan_status;
				echo $scan_status;
				flush();
				ob_flush();
                        }
		}		

		if($scan_status == "finished") {
			$payload = "{\"op\":\"get_output\",\"scan_id\":$scan_id,\"output_format\":\"json\"}";
			$api_url = "https://pentest-tools.com/api?key=$pentesttools_apikey";
                        $ch = curl_init( $api_url );
                        curl_setopt( $ch, CURLOPT_POSTFIELDS, $payload );
                        curl_setopt( $ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
                        curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
                        $json_data = curl_exec($ch);
			curl_close($ch);



			$payload = "{\"op\":\"delete_scan\",\"scan_id\":$scan_id}";
			$api_url = "https://pentest-tools.com/api?key=$pentesttools_apikey";
                        $ch = curl_init( $api_url );
                        curl_setopt( $ch, CURLOPT_POSTFIELDS, $payload );
                        curl_setopt( $ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
                        curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
			curl_close($ch);

			print_r($json_data);
			flush();
			ob_flush();
		}

		else {
			echo "There is an error...";
		}




	} else {
		echo "
<form class='form-inline' action='#' method='POST'>
  <div class='input-group col-md-8'> 
    <div class='input-group-prepend'>
      <div class='input-group-text'>URL: </div>
    </div>
    <input type='text' class='form-control' name='url' id='url' placeholder='URL to scan'>
  </div>
  <div class='col-md-2'>
    <input class='btn btn-danger' type='submit' name='submit' id='submit' value='Scan URL'>
  </div>
</form>

		";
	}
}

add_shortcode('freescan', 'freescan');
